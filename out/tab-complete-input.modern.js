import{defineComponent as t,h as s,nextTick as i}from"vue";function e(){return(e=Object.assign||function(t){for(var s=1;s<arguments.length;s++){var i=arguments[s];for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])}return t}).apply(this,arguments)}const o={enableCache:!0,insertOrder:!1,returnRoot:!1};class n{constructor(t){this.options=o,this.root={},this.index=0;for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(this.options[s]=t[s]);"function"!=typeof this.options.insert&&(this.options.insert=(t,s)=>{let i;return this.options.insertOrder&&!function(t){return void 0!==t.d&&void 0!==t.o}(s)&&(i={d:s,o:this.index++}),t&&t.length?t.push(s):t=[s],t}),"function"!=typeof this.options.sort&&(this.options.insertOrder?this.options.insertOrder&&(this.options.sort=function(){this.sort((t,s)=>void 0===t.o||void 0===s.o?0:t.o-s.o)}):this.options.sort=function(){this.sort()}),"function"!=typeof this.options.clip&&(this.options.clip=function(t){this.length>t&&this.splice(t,this.length-t)}),"function"!=typeof this.options.copy&&(this.options.copy=t=>t.slice(0)),"function"!=typeof this.options.merge&&(this.options.merge=(t,s,i)=>{for(let e=0,o=s.length;e<o;e++)t=this.options.insert.call(this,t,s[e]),this.options.sort.call(t,i);return t})}_addCacheData(t,s){return!(this.root===t&&!this.options.returnRoot||!1===this.options.enableCache||(t.$d||(t.$d={}),t.$d=this.options.insert.call(this,t.$d,s),this.options.sort.call(t.$d),0))}_addSuffix(t,s,i){const e=t.charAt(0),o=t.substring(1)||null,n={$d:{}};o&&(n.$s=o),void 0===i[e]?i[e]=n:void 0===i[e].$d&&(i[e].$d={},o&&void 0===i[e].$s&&(i[e].$s=o)),i[e].$d=this.options.insert.call(this,i[e].$d,s),this.options.sort.call(i[e].$d)}_moveSuffix(t,s,i){const e=t.charAt(0),o=t.substring(1)||null,n={$d:{}};o&&(n.$s=o),void 0===i[e]&&(i[e]=n),i[e].$d=this.options.copy(s)}_getDataAtNode(t,s){let i;return this.options.enableCache?(this.options.sort.call(t.$d,s),i=t.$d):i=this._getSubtree(t,s),this.options.insertOrder&&(i=this._stripInsertOrder(i)),i?this.options.copy(i):void 0}_stripInsertOrder(t){if(void 0===t)return;const s=[];for(let i=0,e=t.length;i<e;i++)s.push(t[i].d);return s}_getSubtree(t,s){let i=[];const e=[t];let o;for(;o=e.pop();)for(const t in o)Object.prototype.hasOwnProperty.call(o,t)&&("$d"==t?i=this.options.merge.call(this,i,o.$d,s):"$s"!=t&&e.push(o[t]));return i}add(t,s){if("string"!=typeof t)return!1;1==arguments.length&&(s=t),t=t.toLowerCase();let i=this.root;for(let e=0,o=t.length;e<o;e++){const n=t.charAt(e);if(i[n])e==o-1?(this._addCacheData(i,s),this._addCacheData(i[n],s)||this._addSuffix(n,s,i)):(this._addCacheData(i,s),i=i[n]);else{if(i.$s){if(i.$s==t.substring(e)){this._addCacheData(i,s)||(i.$d=this.options.insert.call(this,i.$d,s),this.options.sort.call(i.$d));break}this._moveSuffix(i.$s,i.$d,i),delete i.$s,!1===this.options.enableCache&&delete i.$d}if(!i[n]){this._addSuffix(t.substring(e),s,i),this._addCacheData(i,s);break}this._addCacheData(i,s),e==o-1&&(i[n].$s?(this._moveSuffix(i[n].$s,i[n].$d,i[n]),delete i[n].$s,!1===this.options.enableCache&&delete i[n].$d,this._addSuffix(n,s,i)):this._addCacheData(i[n],s)||this._addSuffix(n,s,i)),i=i[n]}}}contains(t){if("string"!=typeof t||""==t)return!1;t=t.toLowerCase();let s=this.root;for(let i=0,e=t.length;i<e;i++){const e=t.charAt(i);if(!s[e])return!(!s.$s||s.$s!==t.substring(i));s=s[e]}return!(!s.$d||void 0!==s.$s)}find(t){if("string"!=typeof t)return;if(""==t&&!this.options.returnRoot)return;t=t.toLowerCase();let s=this.root;for(let i=0,e=t.length;i<e;i++){const e=t.charAt(i);if(!s[e])return s.$s&&0==s.$s.indexOf(t.substring(i))?this._getDataAtNode(s,t):void 0;s=s[e]}return this._getDataAtNode(s,t)}}function r(t){return!!t.bind}var a=t({name:"tab-complete-input",emits:["tab-failed","tab-success","tab-ended","selection-changed","update:modelValue"],data(){return{trie:new n,position:0,wordPos:0,index:0,words:[],word:"",possible:!1,saved:!1,localValue:this.modelValue,isTypeahead:!1}},render(){const t=[this.tabComplete];return"function"==typeof this.$attrs.onKeydown&&t.push(this.$attrs.onKeydown),Array.isArray(this.$attrs.onKeydown)&&t.push(...this.$attrs.onKeydown),s("input",e({ref:"input"},this.$props,this.$attrs,{value:this.modelValue,"onUpdate:modelValue":t=>this.localValue=t,onKeydown:t,onInput:t=>{this.updateValue(t.target.value),this.typeaheadCompletion()}}))},created(){r(this.dataSource)||this.setData(this.dataSource)},props:{dataSource:{default:()=>[]},format:{type:Function,default:(t,s,i)=>({word:t,prev:s})},modelValue:{default:""},startCompletionChar:{default:"@"}},watch:{dataSource(t){r(t)||this.setData(t)}},methods:{setData(t){this.trie=new n,t.forEach(t=>{this.trie.add(t)})},getCurrentWord(){this.position=this.getCursorPos();const t=this.localValue.slice(0,this.position)+" "+this.localValue.slice(this.position);this.words=t.split(" ");let s=0;for(let t=0;t<this.words.length;t++)if(s+=this.words[t].length+1,s>=this.position){this.word=this.words[t],this.wordPos=t;break}},async getCompletions(t){if(r(this.dataSource)){const t=this.dataSource(this.word,this.wordPos),s=await t;this.setData(s)}this.saved=!0,this.possible=this.trie.find(this.word),this.emitEvents(t)},selectCompletion(t){if(!this.possible)return;void 0!==t&&t<this.possible.length&&(this.index=t),this.isTypeahead=!1;const s=this.words;let e="";s.length>1&&(e=s[this.wordPos-1]);const o=this.format(this.possible[this.index],e,this.wordPos);s[this.wordPos]=o.word,o.prev&&(s[this.wordPos-1]=o.prev);const n=this.words.slice(0,this.wordPos+1).join(" ").length;this.localValue=s.join(" "),this.localValue=this.localValue.slice(0,n)+this.localValue.slice(n+1),this.updateValue(this.localValue),i(()=>this.selectRange(n,n)),this.$emit("selection-changed",{completions:this.possible,word:this.word,current:this.index})},emitEvents(t){this.$emit(this.possible?"tab-success":this.saved?"tab-failed":"tab-ended",{original:t,completions:this.possible,word:this.word,current:this.index})},async handleTabPressed(t){this.saved?this.index++:(null==t||t.preventDefault(),await this.getCompletions(t)),this.possible&&(null==t||t.preventDefault(),this.index>=this.possible.length&&(this.index=0),this.selectCompletion())},async tabComplete(t){t&&(this.getCurrentWord(),"tab"!==t.key&&9!==t.keyCode?this.isTypeahead||(this.saved=!1,this.possible=!1,this.index=0,this.emitEvents(t)):await this.handleTabPressed(t))},async typeaheadCompletion(){if(this.word.startsWith(this.startCompletionChar))return this.word=this.word.replace(this.startCompletionChar,""),await this.getCompletions(),void(this.isTypeahead=!0);this.isTypeahead&&(await this.getCompletions(),this.possible||(this.isTypeahead=!1))},updateValue(t){this.localValue=t,this.$emit("update:modelValue",t)},selectRange(t,s){this.$el.focus(),this.$el.setSelectionRange(t,s)},getCursorPos(){return this.$el.selectionStart}}});export default a;
//# sourceMappingURL=tab-complete-input.modern.js.map
